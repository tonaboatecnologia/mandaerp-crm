<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico ERP - PWA</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f77f00;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-size: 0.9rem;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .app-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .search-box {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
            max-width: 100%;
        }

        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-filter input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 20px;
        }

        .card-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .form-check input {
            margin-right: 10px;
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-group label, .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }

        .radio-group input, .checkbox-group input {
            margin-right: 8px;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--secondary);
            margin: 25px 0 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eee;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .actions button {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: var(--danger);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--danger);
        }

        .notification.info {
            background-color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }

        @media (max-width: 768px) {
            .app-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                width: 100%;
            }

            .data-table {
                font-size: 0.9rem;
            }

            .data-table th, .data-table td {
                padding: 8px 10px;
            }

            .actions {
                flex-direction: column;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            header {
                flex-direction: column;
                text-align: center;
            }
            
            .user-info {
                margin-top: 10px;
            }
            
            .date-filter {
                flex-direction: column;
                width: 100%;
            }
            
            .date-filter input {
                width: 100%;
            }
        }

        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }

        .install-banner button {
            background: white;
            color: var(--primary);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        .login-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
        
        .login-card h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
        }
        
        .login-card .form-group {
            margin-bottom: 20px;
        }
        
        .login-card .btn {
            width: 100%;
            justify-content: center;
        }
        
        .credentials-info {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .credentials-info h4 {
            margin-bottom: 10px;
            color: var(--secondary);
        }
        
        .credentials-info p {
            margin-bottom: 5px;
        }
        
        .dashboard {
            display: none;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            color: var(--gray);
        }
        
        /* Notifica√ß√µes */
        .notifications-modal {
            max-width: 600px;
        }
        
        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            transition: background-color 0.2s;
        }
        
        .notification-item:hover {
            background-color: #f8f9fa;
        }
        
        .notification-item.unread {
            background-color: #e3f2fd;
            border-left: 4px solid var(--primary);
        }
        
        .notification-icon {
            font-size: 1.5rem;
            color: var(--primary);
            margin-top: 3px;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .notification-message {
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .notification-time {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
        }
        
        .notification-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        /* Pagina√ß√£o */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination button:hover:not(:disabled) {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .pagination button.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* Filtros avan√ßados */
        .advanced-filters {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <h2><i class="fas fa-clipboard-check"></i> Diagn√≥stico ERP</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usu√°rio:</label>
                    <input type="text" id="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
            </form>
            
            <div class="credentials-info">
                <h4>Credenciais de Acesso:</h4>
                <p><strong>Administrador:</strong> admin / admin123</p>
                <p><strong>Funcion√°rio:</strong> funcionario / func123</p>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <header>
            <div class="container">
                <div>
                    <h1><i class="fas fa-clipboard-check"></i> Diagn√≥stico ERP - Manda</h1>
                    <p>Sistema de registro e an√°lise de question√°rios de diagn√≥stico</p>
                </div>
                <div class="user-info">
                    <div class="notification-bell" id="notificationBell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">0</span>
                    </div>
                    <span><i class="fas fa-user"></i> <span id="currentUser"></span></span>
                    <span><i class="fas fa-user-tag"></i> <span id="userRole"></span></span>
                    <button class="btn btn-danger" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Estat√≠sticas -->
            <div class="stats-container">
                <div class="stat-card">
                    <i class="fas fa-clipboard-list"></i>
                    <h3 id="totalRecords">0</h3>
                    <p>Total de Question√°rios</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-building"></i>
                    <h3 id="totalCompanies">0</h3>
                    <p>Empresas Cadastradas</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-line"></i>
                    <h3 id="thisMonthRecords">0</h3>
                    <p>Registros Este M√™s</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-star"></i>
                    <h3 id="highPriorityRecords">0</h3>
                    <p>Alta Prioridade</p>
                </div>
            </div>

            <!-- Filtros Avan√ßados (apenas para admin) -->
            <div id="advancedFilters" class="advanced-filters" style="display: none;">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterStartDate">Data Inicial:</label>
                        <input type="date" id="filterStartDate" class="form-control">
                    </div>
                    <div class="filter-group">
                        <label for="filterEndDate">Data Final:</label>
                        <input type="date" id="filterEndDate" class="form-control">
                    </div>
                    <div class="filter-group">
                        <label for="filterSetor">Setor:</label>
                        <select id="filterSetor" class="form-control">
                            <option value="">Todos</option>
                            <option value="Com√©rcio">Com√©rcio</option>
                            <option value="Sa√∫de">Sa√∫de</option>
                            <option value="Educa√ß√£o">Educa√ß√£o</option>
                            <option value="Constru√ß√£o">Constru√ß√£o</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterUrgencia">Urg√™ncia:</label>
                        <select id="filterUrgencia" class="form-control">
                            <option value="">Todas</option>
                            <option value="Alta">Alta</option>
                            <option value="M√©dia">M√©dia</option>
                            <option value="Baixa">Baixa</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" id="applyFilters">
                        <i class="fas fa-filter"></i> Aplicar Filtros
                    </button>
                    <button class="btn btn-warning" id="clearFilters">
                        <i class="fas fa-times"></i> Limpar Filtros
                    </button>
                </div>
            </div>

            <div class="app-controls">
                <div>
                    <button class="btn btn-primary" id="newFormBtn">
                        <i class="fas fa-plus"></i> Novo Question√°rio
                    </button>
                    <button class="btn btn-success" id="exportCsvBtn">
                        <i class="fas fa-file-csv"></i> Exportar CSV
                    </button>
                    <button class="btn btn-info" id="exportPdfBtn">
                        <i class="fas fa-file-pdf"></i> Exportar PDF Global
                    </button>
                </div>
                <input type="text" class="search-box" id="searchInput" placeholder="Buscar question√°rios...">
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-list"></i> Question√°rios Registrados</h2>
                    <span id="recordCount">0 registros</span>
                </div>
                <div id="recordsContainer">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Nenhum question√°rio encontrado</h3>
                        <p>Tente ajustar sua busca ou cadastre um novo question√°rio</p>
                    </div>
                </div>
                <div id="paginationContainer" class="pagination" style="display: none;">
                    <button id="prevPage"><i class="fas fa-chevron-left"></i></button>
                    <div id="pageNumbers"></div>
                    <button id="nextPage"><i class="fas fa-chevron-right"></i></button>
                    <div class="pagination-info">
                        <span id="paginationInfo"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Formul√°rio -->
    <div id="formModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Novo Question√°rio de Diagn√≥stico</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="perfil">Perfil da Empresa</div>
                <div class="tab" data-tab="processos">Diagn√≥stico de Processos</div>
                <div class="tab" data-tab="necessidades">Necessidades Espec√≠ficas</div>
                <div class="tab" data-tab="expectativas">Expectativas e Decis√£o</div>
                <div class="tab" data-tab="analise">An√°lise do Consultor</div>
            </div>
            
            <form id="diagnosisForm">
                <!-- Se√ß√£o 1 - Perfil da Empresa -->
                <div class="tab-content active" id="perfil">
                    <h3 class="section-title">1.1 Dados B√°sicos</h3>
                    
                    <div class="form-group">
                        <label for="nome_empresa">Nome da empresa:</label>
                        <input type="text" id="nome_empresa" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Setor:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="setor" value="Com√©rcio"> Com√©rcio</label>
                            <label><input type="radio" name="setor" value="Sa√∫de"> Sa√∫de</label>
                            <label><input type="radio" name="setor" value="Educa√ß√£o"> Educa√ß√£o</label>
                            <label><input type="radio" name="setor" value="Constru√ß√£o"> Constru√ß√£o</label>
                            <label>
                                <input type="radio" name="setor" value="Outro"> Outro:
                                <input type="text" id="setor_outro" class="form-control" style="width: 150px; display: inline-block; margin-left: 10px;">
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>N¬∫ de funcion√°rios:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="num_funcionarios" value="1-10"> 1-10</label>
                            <label><input type="radio" name="num_funcionarios" value="11-50"> 11-50</label>
                            <label><input type="radio" name="num_funcionarios" value="51-200"> 51-200</label>
                            <label><input type="radio" name="num_funcionarios" value="200+"> 200+</label>
                        </div>
                    </div>
                    
                    <h3 class="section-title">1.2 Contexto Operacional</h3>
                    
                    <div class="form-group">
                        <label>Faturamento mensal:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="faturamento_mensal" value="At√© 500K"> At√© 500K</label>
                            <label><input type="radio" name="faturamento_mensal" value="500K-2M"> 500K-2M</label>
                            <label><input type="radio" name="faturamento_mensal" value="Acima de 2M"> Acima de 2M</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Possui filiais?</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="possui_filiais" value="Sim"> Sim
                                <input type="text" id="num_filiais" class="form-control" style="width: 80px; display: inline-block; margin-left: 10px;" placeholder="N¬∫">
                            </label>
                            <label><input type="radio" name="possui_filiais" value="N√£o"> N√£o</label>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o 2 - Diagn√≥stico de Processos -->
                <div class="tab-content" id="processos">
                    <h3 class="section-title">2.1 Sistemas Atuais</h3>
                    
                    <div class="form-group">
                        <label for="sistema_utilizado">Sistema utilizado:</label>
                        <input type="text" id="sistema_utilizado" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label>Tempo de uso:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="tempo_sistema" value="<1 ano"> <1 ano</label>
                            <label><input type="radio" name="tempo_sistema" value="1-3 anos"> 1-3 anos</label>
                            <label><input type="radio" name="tempo_sistema" value=">3 anos"> >3 anos</label>
                        </div>
                    </div>
                    
                    <h3 class="section-title">2.2 Principais Dores (at√© 3)</h3>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="dores" value="Processos manuais"> Processos manuais</label>
                            <label><input type="checkbox" name="dores" value="Emiss√£o fiscal dif√≠cil"> Emiss√£o fiscal dif√≠cil</label>
                            <label><input type="checkbox" name="dores" value="Falta controle estoque/finan√ßas"> Falta controle estoque/finan√ßas</label>
                            <label><input type="checkbox" name="dores" value="Concilia√ß√£o banc√°ria"> Concilia√ß√£o banc√°ria</label>
                            <label>
                                <input type="checkbox" name="dores" value="Outro"> Outro:
                                <input type="text" id="dores_outro" class="form-control" style="width: 150px; display: inline-block; margin-left: 10px;">
                            </label>
                        </div>
                    </div>
                    
                    <h3 class="section-title">2.3 Impacto Financeiro</h3>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="impacto_financeiro" value="Erros de fatura√ß√£o"> Erros de fatura√ß√£o</label>
                            <label><input type="checkbox" name="impacto_financeiro" value="Multas fiscais"> Multas fiscais</label>
                            <label><input type="checkbox" name="impacto_financeiro" value="Perdas de estoque"> Perdas de estoque</label>
                            <label><input type="checkbox" name="impacto_financeiro" value="N√£o sabe mensurar"> N√£o sabe mensurar</label>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o 3 - Necessidades Espec√≠ficas -->
                <div class="tab-content" id="necessidades">
                    <h3 class="section-title">3.1 Com√©rcio/Distribui√ß√£o</h3>
                    
                    <div class="form-group">
                        <label for="num_skus">N¬∫ m√©dio de SKUs:</label>
                        <input type="text" id="num_skus" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="comercio_dores" value="Vendas n√£o registradas"> Vendas n√£o registradas</label>
                            <label><input type="checkbox" name="comercio_dores" value="Dificuldade impostos"> Dificuldade impostos</label>
                            <label><input type="checkbox" name="comercio_dores" value="Troca pre√ßos errados"> Troca pre√ßos errados</label>
                        </div>
                    </div>
                    
                    <h3 class="section-title">3.2 Sa√∫de</h3>
                    
                    <div class="form-group">
                        <label for="num_pacientes">N¬∫ pacientes/m√™s:</label>
                        <input type="text" id="num_pacientes" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="saude_dores" value="Agendamentos sobrepostos"> Agendamentos sobrepostos</label>
                            <label><input type="checkbox" name="saude_dores" value="Medicamentos vencidos"> Medicamentos vencidos</label>
                            <label><input type="checkbox" name="saude_dores" value="Fatura√ß√£o atrasada"> Fatura√ß√£o atrasada</label>
                        </div>
                    </div>
                    
                    <h3 class="section-title">3.3 Educa√ß√£o</h3>
                    
                    <div class="form-group">
                        <label for="num_alunos">N¬∫ alunos:</label>
                        <input type="text" id="num_alunos" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="educacao_dores" value="Inadimpl√™ncia"> Inadimpl√™ncia</label>
                            <label><input type="checkbox" name="educacao_dores" value="Controle manual de notas"> Controle manual de notas</label>
                            <label><input type="checkbox" name="educacao_dores" value="Comunica√ß√£o com respons√°veis"> Comunica√ß√£o com respons√°veis</label>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o 4 - Expectativas e Decis√£o -->
                <div class="tab-content" id="expectativas">
                    <h3 class="section-title">4.1 Crit√©rios de Escolha</h3>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="criterios_escolha" value="Pre√ßo"> Pre√ßo</label>
                            <label><input type="checkbox" name="criterios_escolha" value="Suporte local"> Suporte local</label>
                            <label><input type="checkbox" name="criterios_escolha" value="Facilidade de uso"> Facilidade de uso</label>
                            <label><input type="checkbox" name="criterios_escolha" value="Certifica√ß√£o AGT"> Certifica√ß√£o AGT</label>
                        </div>
                    </div>
                    
                    <h3 class="section-title">4.2 Tempo de Implementa√ß√£o</h3>
                    
                    <div class="form-group">
                        <div class="radio-group">
                            <label><input type="radio" name="tempo_implementacao" value="Imediato (<1 m√™s)"> Imediato (<1 m√™s)</label>
                            <label><input type="radio" name="tempo_implementacao" value="1-3 meses"> 1-3 meses</label>
                            <label><input type="radio" name="tempo_implementacao" value="Apenas pesquisando"> Apenas pesquisando</label>
                        </div>
                    </div>
                    
                    <h3 class="section-title">4.3 Processo Decis√≥rio</h3>
                    
                    <div class="form-group">
                        <label>Envolvidos:</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="envolvidos" value="CEO/Diretor"> CEO/Diretor</label>
                            <label><input type="checkbox" name="envolvidos" value="Financeiro"> Financeiro</label>
                            <label><input type="checkbox" name="envolvidos" value="TI"> TI</label>
                            <label>
                                <input type="checkbox" name="envolvidos" value="Outro"> Outro:
                                <input type="text" id="envolvidos_outro" class="form-control" style="width: 150px; display: inline-block; margin-left: 10px;">
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o 5 - An√°lise do Consultor -->
                <div class="tab-content" id="analise">
                    <h3 class="section-title">An√°lise do Consultor</h3>
                    
                    <div class="form-group">
                        <label>Urg√™ncia:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="urgencia" value="Alta"> Alta</label>
                            <label><input type="radio" name="urgencia" value="M√©dia"> M√©dia</label>
                            <label><input type="radio" name="urgencia" value="Baixa"> Baixa</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="modulos_prioritarios">M√≥dulos Priorit√°rios:</label>
                        <input type="text" id="modulos_prioritarios" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="observacoes">Observa√ß√µes:</label>
                        <textarea id="observacoes" class="form-control" rows="4"></textarea>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar Question√°rio
                    </button>
                    <button type="button" class="btn btn-danger" id="cancelBtn">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Notifica√ß√µes -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content notifications-modal">
            <span class="close">&times;</span>
            <div class="notifications-header">
                <h2><i class="fas fa-bell"></i> Notifica√ß√µes</h2>
                <button class="btn btn-primary" id="markAllRead">
                    <i class="fas fa-check-double"></i> Marcar todas como lidas
                </button>
            </div>
            <div id="notificationsList" class="notifications-list">
                <div class="empty-state">
                    <i class="fas fa-bell-slash"></i>
                    <h3>Nenhuma notifica√ß√£o</h3>
                    <p>Voc√™ n√£o tem notifica√ß√µes no momento</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Banner de Instala√ß√£o -->
    <div class="install-banner" id="installBanner">
        <div>Instale este aplicativo para acesso offline</div>
        <button id="installBtn">Instalar</button>
    </div>

    <!-- Notifica√ß√£o -->
    <div id="notification" class="notification"></div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        // Vari√°veis globais
        let records = JSON.parse(localStorage.getItem('diagnosisRecords')) || [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let currentUser = null;
        let currentEditId = null;
        let deferredPrompt;
        let currentPage = 1;
        const recordsPerPage = 10;
        let filteredRecords = [...records];

        // Elementos do DOM
        const loginContainer = document.getElementById('loginContainer');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentUserSpan = document.getElementById('currentUser');
        const userRoleSpan = document.getElementById('userRole');
        const notificationBell = document.getElementById('notificationBell');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationsModal = document.getElementById('notificationsModal');
        const notificationsList = document.getElementById('notificationsList');
        const markAllReadBtn = document.getElementById('markAllRead');
        const formModal = document.getElementById('formModal');
        const newFormBtn = document.getElementById('newFormBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const searchInput = document.getElementById('searchInput');
        const recordsContainer = document.getElementById('recordsContainer');
        const recordCount = document.getElementById('recordCount');
        const diagnosisForm = document.getElementById('diagnosisForm');
        const modalTitle = document.getElementById('modalTitle');
        const cancelBtn = document.getElementById('cancelBtn');
        const closeBtn = document.querySelectorAll('.close');
        const notification = document.getElementById('notification');
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');
        
        // Filtros avan√ßados
        const advancedFilters = document.getElementById('advancedFilters');
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const filterSetor = document.getElementById('filterSetor');
        const filterUrgencia = document.getElementById('filterUrgencia');
        const applyFiltersBtn = document.getElementById('applyFilters');
        const clearFiltersBtn = document.getElementById('clearFilters');
        
        // Pagina√ß√£o
        const paginationContainer = document.getElementById('paginationContainer');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageNumbers = document.getElementById('pageNumbers');
        const paginationInfo = document.getElementById('paginationInfo');
        
        // Estat√≠sticas
        const totalRecordsEl = document.getElementById('totalRecords');
        const totalCompaniesEl = document.getElementById('totalCompanies');
        const thisMonthRecordsEl = document.getElementById('thisMonthRecords');
        const highPriorityRecordsEl = document.getElementById('highPriorityRecords');

        // Event Listeners
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        notificationBell.addEventListener('click', openNotifications);
        markAllReadBtn.addEventListener('click', markAllAsRead);
        newFormBtn.addEventListener('click', openNewForm);
        exportCsvBtn.addEventListener('click', exportData);
        exportPdfBtn.addEventListener('click', exportGlobalPDF);
        searchInput.addEventListener('input', handleSearch);
        diagnosisForm.addEventListener('submit', saveForm);
        cancelBtn.addEventListener('click', closeModal);
        closeBtn.forEach(btn => btn.addEventListener('click', () => {
            formModal.style.display = 'none';
            notificationsModal.style.display = 'none';
        }));
        installBtn.addEventListener('click', installApp);
        
        // Filtros
        applyFiltersBtn.addEventListener('click', applyAdvancedFilters);
        clearFiltersBtn.addEventListener('click', clearAdvancedFilters);
        
        // Pagina√ß√£o
        prevPageBtn.addEventListener('click', () => changePage(currentPage - 1));
        nextPageBtn.addEventListener('click', () => changePage(currentPage + 1));

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Ativar aba
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Mostrar conte√∫do da aba
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Banner de instala√ß√£o
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBanner.style.display = 'flex';
        });

        // Fun√ß√µes de Notifica√ß√£o
        function addNotification(title, message, type = 'info') {
            const newNotification = {
                id: Date.now(),
                title,
                message,
                type,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            notifications.unshift(newNotification);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationBadge();
            
            // Mostrar notifica√ß√£o tempor√°ria
            showNotification(message, type);
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            notificationBadge.textContent = unreadCount;
            notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }

        function openNotifications() {
            notificationsModal.style.display = 'block';
            renderNotifications();
        }

        function renderNotifications() {
            if (notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>Nenhuma notifica√ß√£o</h3>
                        <p>Voc√™ n√£o tem notifica√ß√µes no momento</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            notifications.forEach(notification => {
                const date = new Date(notification.timestamp);
                const timeAgo = getTimeAgo(date);
                
                html += `
                    <div class="notification-item ${notification.read ? '' : 'unread'}" data-id="${notification.id}">
                        <div class="notification-icon">
                            <i class="fas ${getNotificationIcon(notification.type)}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">${notification.title}</div>
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${timeAgo}</div>
                        </div>
                        <div class="notification-actions">
                            ${!notification.read ? `
                                <button class="btn btn-primary" onclick="markAsRead(${notification.id})">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-danger" onclick="deleteNotification(${notification.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            notificationsList.innerHTML = html;
        }

        function getNotificationIcon(type) {
            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            return icons[type] || icons.info;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " anos atr√°s";
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " meses atr√°s";
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " dias atr√°s";
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " horas atr√°s";
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutos atr√°s";
            
            return "Agora mesmo";
        }

        function markAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                localStorage.setItem('notifications', JSON.stringify(notifications));
                updateNotificationBadge();
                renderNotifications();
            }
        }

        function markAllAsRead() {
            notifications.forEach(n => n.read = true);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationBadge();
            renderNotifications();
            showNotification('Todas as notifica√ß√µes foram marcadas como lidas', 'success');
        }

        function deleteNotification(id) {
            notifications = notifications.filter(n => n.id !== id);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationBadge();
            renderNotifications();
        }

        // Fun√ß√µes de Autentica√ß√£o
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Credenciais pr√©-definidas
            const users = [
                { username: 'admin', password: 'admin123', role: 'admin' },
                { username: 'funcionario', password: 'func123', role: 'funcionario' }
            ];
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                currentUserSpan.textContent = user.username;
                userRoleSpan.textContent = user.role === 'admin' ? 'Administrador' : 'Funcion√°rio';
                
                loginContainer.style.display = 'none';
                dashboard.style.display = 'block';
                
                // Configurar permiss√µes
                setupPermissions();
                
                // Atualizar dashboard
                updateDashboard();
                applyFilters();
                
                // Adicionar notifica√ß√£o de boas-vindas
                addNotification(
                    'Bem-vindo!',
                    `Voc√™ fez login como ${user.role === 'admin' ? 'Administrador' : 'Funcion√°rio'}`,
                    'success'
                );
                
                showNotification('Login realizado com sucesso!', 'success');
            } else {
                showNotification('Usu√°rio ou senha inv√°lidos!', 'error');
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            loginContainer.style.display = 'flex';
            dashboard.style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showNotification('Logout realizado com sucesso!', 'info');
        }

        function setupPermissions() {
            // Admin tem acesso total
            if (currentUser.role === 'admin') {
                // Todos os bot√µes vis√≠veis
                newFormBtn.style.display = 'inline-flex';
                exportCsvBtn.style.display = 'inline-flex';
                exportPdfBtn.style.display = 'inline-flex';
                advancedFilters.style.display = 'block';
            } 
            // Funcion√°rio tem acesso limitado
            else if (currentUser.role === 'funcionario') {
                // Pode ver e criar, mas n√£o exportar
                newFormBtn.style.display = 'inline-flex';
                exportCsvBtn.style.display = 'none';
                exportPdfBtn.style.display = 'none';
                advancedFilters.style.display = 'none';
            }
        }

        function updateDashboard() {
            // Total de registros
            totalRecordsEl.textContent = records.length;
            
            // Total de empresas (√∫nicas)
            const uniqueCompanies = new Set();
            records.forEach(record => {
                if (record.data.nome_empresa && record.data.nome_empresa[0]) {
                    uniqueCompanies.add(record.data.nome_empresa[0]);
                }
            });
            totalCompaniesEl.textContent = uniqueCompanies.size;
            
            // Registros deste m√™s
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const thisMonthRecords = records.filter(record => {
                const recordDate = new Date(record.createdAt);
                return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
            });
            thisMonthRecordsEl.textContent = thisMonthRecords.length;
            
            // Registros de alta prioridade
            const highPriorityRecords = records.filter(record => {
                return record.data.urgencia && record.data.urgencia[0] === 'Alta';
            });
            highPriorityRecordsEl.textContent = highPriorityRecords.length;
        }

        // Fun√ß√µes de Filtros e Pagina√ß√£o
        function applyAdvancedFilters() {
            const startDate = filterStartDate.value;
            const endDate = filterEndDate.value;
            const setor = filterSetor.value;
            const urgencia = filterUrgencia.value;
            
            filteredRecords = records.filter(record => {
                const recordDate = new Date(record.createdAt);
                
                // Filtro de data inicial
                if (startDate && recordDate < new Date(startDate)) {
                    return false;
                }
                
                // Filtro de data final
                if (endDate) {
                    const endDateObj = new Date(endDate);
                    endDateObj.setHours(23, 59, 59, 999);
                    if (recordDate > endDateObj) {
                        return false;
                    }
                }
                
                // Filtro de setor
                if (setor && record.data.setor && record.data.setor[0] !== setor) {
                    return false;
                }
                
                // Filtro de urg√™ncia
                if (urgencia && record.data.urgencia && record.data.urgencia[0] !== urgencia) {
                    return false;
                }
                
                return true;
            });
            
            currentPage = 1;
            renderRecords();
            showNotification('Filtros aplicados com sucesso!', 'success');
        }

        function clearAdvancedFilters() {
            filterStartDate.value = '';
            filterEndDate.value = '';
            filterSetor.value = '';
            filterUrgencia.value = '';
            
            filteredRecords = [...records];
            currentPage = 1;
            renderRecords();
            showNotification('Filtros limpos com sucesso!', 'info');
        }

        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            
            if (searchTerm === '') {
                filteredRecords = [...records];
            } else {
                filteredRecords = records.filter(record => {
                    const nome = record.data.nome_empresa ? record.data.nome_empresa[0].toLowerCase() : '';
                    const setor = record.data.setor ? record.data.setor[0].toLowerCase() : '';
                    
                    return nome.includes(searchTerm) || setor.includes(searchTerm);
                });
            }
            
            currentPage = 1;
            renderRecords();
        }

        function applyFilters() {
            // Aplicar filtros avan√ßados se estiverem preenchidos
            if (filterStartDate.value || filterEndDate.value || filterSetor.value || filterUrgencia.value) {
                applyAdvancedFilters();
            } else {
                filteredRecords = [...records];
                renderRecords();
            }
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
            
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderRecords();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            // Atualizar bot√µes de navega√ß√£o
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            
            // Gerar n√∫meros de p√°gina
            let pageNumbersHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                pageNumbersHTML += `<button onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    pageNumbersHTML += `<span>...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                pageNumbersHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pageNumbersHTML += `<span>...</span>`;
                }
                pageNumbersHTML += `<button onclick="changePage(${totalPages})">${totalPages}</button>`;
            }
            
            pageNumbers.innerHTML = pageNumbersHTML;
            
            // Atualizar informa√ß√£o de pagina√ß√£o
            const startRecord = (currentPage - 1) * recordsPerPage + 1;
            const endRecord = Math.min(currentPage * recordsPerPage, filteredRecords.length);
            paginationInfo.textContent = `${startRecord}-${endRecord} de ${filteredRecords.length}`;
        }

        // Fun√ß√µes do Formul√°rio
        function openNewForm() {
            currentEditId = null;
            modalTitle.textContent = 'Novo Question√°rio de Diagn√≥stico';
            diagnosisForm.reset();
            formModal.style.display = 'block';
        }

        function closeModal() {
            formModal.style.display = 'none';
        }

        function saveForm(e) {
            e.preventDefault();
            
            const formData = new FormData(diagnosisForm);
            const record = {
                id: currentEditId || Date.now(),
                data: {},
                createdAt: currentEditId ? records.find(r => r.id === currentEditId).createdAt : new Date().toISOString(),
                createdBy: currentUser.username
            };
            
            // Coletar dados do formul√°rio
            for (let [key, value] of formData.entries()) {
                if (!record.data[key]) {
                    record.data[key] = [];
                }
                record.data[key].push(value);
            }
            
            // Tratar campos especiais
            if (formData.get('setor') === 'Outro') {
                record.data.setor = [document.getElementById('setor_outro').value];
            }
            
            if (formData.get('possui_filiais') === 'Sim') {
                record.data.num_filiais = [document.getElementById('num_filiais').value];
            }
            
            if (formData.getAll('dores').includes('Outro')) {
                record.data.dores_outro = [document.getElementById('dores_outro').value];
            }
            
            if (formData.getAll('envolvidos').includes('Outro')) {
                record.data.envolvidos_outro = [document.getElementById('envolvidos_outro').value];
            }
            
            // Adicionar campos de texto √∫nicos
            record.data.nome_empresa = [document.getElementById('nome_empresa').value];
            record.data.sistema_utilizado = [document.getElementById('sistema_utilizado').value];
            record.data.num_skus = [document.getElementById('num_skus').value];
            record.data.num_pacientes = [document.getElementById('num_pacientes').value];
            record.data.num_alunos = [document.getElementById('num_alunos').value];
            record.data.modulos_prioritarios = [document.getElementById('modulos_prioritarios').value];
            record.data.observacoes = [document.getElementById('observacoes').value];
            
            // Salvar ou atualizar
            if (currentEditId) {
                const index = records.findIndex(r => r.id === currentEditId);
                records[index] = record;
                addNotification(
                    'Question√°rio Atualizado',
                    `O question√°rio da empresa "${record.data.nome_empresa[0]}" foi atualizado`,
                    'info'
                );
                showNotification('Question√°rio atualizado com sucesso!', 'success');
            } else {
                records.push(record);
                addNotification(
                    'Novo Question√°rio',
                    `Um novo question√°rio foi adicionado para a empresa "${record.data.nome_empresa[0]}"`,
                    'success'
                );
                showNotification('Question√°rio salvo com sucesso!', 'success');
            }
            
            localStorage.setItem('diagnosisRecords', JSON.stringify(records));
            updateDashboard();
            applyFilters();
            closeModal();
        }

        function renderRecords() {
            if (filteredRecords.length === 0) {
                recordsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Nenhum question√°rio encontrado</h3>
                        <p>Tente ajustar sua busca ou cadastre um novo question√°rio</p>
                    </div>
                `;
                recordCount.textContent = '0 registros';
                paginationContainer.style.display = 'none';
                return;
            }
            
            // Calcular registros para a p√°gina atual
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const pageRecords = filteredRecords.slice(startIndex, endIndex);
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Empresa</th>
                            <th>Setor</th>
                            <th>Urg√™ncia</th>
                            <th>Data</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pageRecords.forEach(record => {
                const setor = record.data.setor ? record.data.setor[0] : 'N√£o informado';
                const urgencia = record.data.urgencia ? record.data.urgencia[0] : 'N√£o informado';
                const data = new Date(record.createdAt).toLocaleDateString('pt-BR');
                
                html += `
                    <tr>
                        <td>${record.id}</td>
                        <td>${record.data.nome_empresa ? record.data.nome_empresa[0] : 'N√£o informado'}</td>
                        <td>${setor}</td>
                        <td><span class="badge ${urgencia === 'Alta' ? 'badge-danger' : urgencia === 'M√©dia' ? 'badge-warning' : 'badge-info'}">${urgencia}</span></td>
                        <td>${data}</td>
                        <td class="actions">
                            <button class="btn btn-primary" onclick="viewRecord(${record.id})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="btn btn-warning" onclick="editRecord(${record.id})">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-info" onclick="exportPDF(${record.id})">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            ${currentUser.role === 'admin' ? `
                            <button class="btn btn-danger" onclick="deleteRecord(${record.id})">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            recordsContainer.innerHTML = html;
            recordCount.textContent = `${filteredRecords.length} registros`;
            renderPagination();
        }

        function viewRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            let html = '<div class="card"><div class="card-header"><h2 class="card-title">Detalhes do Question√°rio</h2></div><div>';
            
            // Se√ß√£o 1
            html += '<h3 class="section-title">Se√ß√£o 1 ‚Äì Perfil da Empresa</h3>';
            html += `<p><strong>Nome da empresa:</strong> ${record.data.nome_empresa ? record.data.nome_empresa[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>Setor:</strong> ${record.data.setor ? record.data.setor[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>N¬∫ de funcion√°rios:</strong> ${record.data.num_funcionarios ? record.data.num_funcionarios[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>Faturamento mensal:</strong> ${record.data.faturamento_mensal ? record.data.faturamento_mensal[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>Possui filiais:</strong> ${record.data.possui_filiais ? record.data.possui_filiais[0] : 'N√£o'}`;
            if (record.data.possui_filiais && record.data.possui_filiais[0] === 'Sim' && record.data.num_filiais) {
                html += ` (${record.data.num_filiais[0]})`;
            }
            html += '</p>';
            
            // Se√ß√£o 2
            html += '<h3 class="section-title">Se√ß√£o 2 ‚Äì Diagn√≥stico de Processos</h3>';
            html += `<p><strong>Sistema utilizado:</strong> ${record.data.sistema_utilizado ? record.data.sistema_utilizado[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>Tempo de uso:</strong> ${record.data.tempo_sistema ? record.data.tempo_sistema[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>Principais dores:</strong> ${record.data.dores ? record.data.dores.join(', ') : 'N√£o informado'}`;
            if (record.data.dores && record.data.dores.includes('Outro') && record.data.dores_outro) {
                html += ` (${record.data.dores_outro[0]})`;
            }
            html += '</p>';
            html += `<p><strong>Impacto financeiro:</strong> ${record.data.impacto_financeiro ? record.data.impacto_financeiro.join(', ') : 'N√£o informado'}</p>`;
            
            // Se√ß√£o 3
            html += '<h3 class="section-title">Se√ß√£o 3 ‚Äì Necessidades Espec√≠ficas</h3>';
            html += `<p><strong>N¬∫ m√©dio de SKUs:</strong> ${record.data.num_skus ? record.data.num_skus[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>Dores Com√©rcio:</strong> ${record.data.comercio_dores ? record.data.comercio_dores.join(', ') : 'N√£o informado'}</p>`;
            html += `<p><strong>N¬∫ pacientes/m√™s:</strong> ${record.data.num_pacientes ? record.data.num_pacientes[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>Dores Sa√∫de:</strong> ${record.data.saude_dores ? record.data.saude_dores.join(', ') : 'N√£o informado'}</p>`;
            html += `<p><strong>N¬∫ alunos:</strong> ${record.data.num_alunos ? record.data.num_alunos[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>Dores Educa√ß√£o:</strong> ${record.data.educacao_dores ? record.data.educacao_dores.join(', ') : 'N√£o informado'}</p>`;
            
            // Se√ß√£o 4
            html += '<h3 class="section-title">Se√ß√£o 4 ‚Äì Expectativas e Decis√£o</h3>';
            html += `<p><strong>Crit√©rios de escolha:</strong> ${record.data.criterios_escolha ? record.data.criterios_escolha.join(', ') : 'N√£o informado'}</p>`;
            html += `<p><strong>Tempo de implementa√ß√£o:</strong> ${record.data.tempo_implementacao ? record.data.tempo_implementacao[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>Envolvidos:</strong> ${record.data.envolvidos ? record.data.envolvidos.join(', ') : 'N√£o informado'}`;
            if (record.data.envolvidos && record.data.envolvidos.includes('Outro') && record.data.envolvidos_outro) {
                html += ` (${record.data.envolvidos_outro[0]})`;
            }
            html += '</p>';
            
            // Se√ß√£o 5
            html += '<h3 class="section-title">Se√ß√£o 5 ‚Äì An√°lise do Consultor</h3>';
            html += `<p><strong>Urg√™ncia:</strong> ${record.data.urgencia ? record.data.urgencia[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>M√≥dulos Priorit√°rios:</strong> ${record.data.modulos_prioritarios ? record.data.modulos_prioritarios[0] : 'N√£o informado'}</p>`;
            html += `<p><strong>Observa√ß√µes:</strong> ${record.data.observacoes ? record.data.observacoes[0] : 'N√£o informado'}</p>`;
            
            html += '</div></div>';
            
            recordsContainer.innerHTML = html;
        }

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            currentEditId = id;
            modalTitle.textContent = 'Editar Question√°rio de Diagn√≥stico';
            
            // Preencher formul√°rio
            document.getElementById('nome_empresa').value = record.data.nome_empresa ? record.data.nome_empresa[0] : '';
            
            // Setor
            if (record.data.setor) {
                const setorValue = record.data.setor[0];
                if (setorValue === 'Com√©rcio' || setorValue === 'Sa√∫de' || setorValue === 'Educa√ß√£o' || setorValue === 'Constru√ß√£o') {
                    document.querySelector(`input[name="setor"][value="${setorValue}"]`).checked = true;
                } else {
                    document.querySelector('input[name="setor"][value="Outro"]').checked = true;
                    document.getElementById('setor_outro').value = setorValue;
                }
            }
            
            // N¬∫ funcion√°rios
            if (record.data.num_funcionarios) {
                document.querySelector(`input[name="num_funcionarios"][value="${record.data.num_funcionarios[0]}"]`).checked = true;
            }
            
            // Faturamento
            if (record.data.faturamento_mensal) {
                document.querySelector(`input[name="faturamento_mensal"][value="${record.data.faturamento_mensal[0]}"]`).checked = true;
            }
            
            // Filiais
            if (record.data.possui_filiais) {
                document.querySelector(`input[name="possui_filiais"][value="${record.data.possui_filiais[0]}"]`).checked = true;
                if (record.data.possui_filiais[0] === 'Sim' && record.data.num_filiais) {
                    document.getElementById('num_filiais').value = record.data.num_filiais[0];
                }
            }
            
            // Sistema atual
            document.getElementById('sistema_utilizado').value = record.data.sistema_utilizado ? record.data.sistema_utilizado[0] : '';
            
            // Tempo sistema
            if (record.data.tempo_sistema) {
                document.querySelector(`input[name="tempo_sistema"][value="${record.data.tempo_sistema[0]}"]`).checked = true;
            }
            
            // Dores
            if (record.data.dores) {
                record.data.dores.forEach(dor => {
                    if (dor === 'Outro' && record.data.dores_outro) {
                        document.querySelector('input[name="dores"][value="Outro"]').checked = true;
                        document.getElementById('dores_outro').value = record.data.dores_outro[0];
                    } else {
                        const checkbox = document.querySelector(`input[name="dores"][value="${dor}"]`);
                        if (checkbox) checkbox.checked = true;
                    }
                });
            }
            
            // Impacto financeiro
            if (record.data.impacto_financeiro) {
                record.data.impacto_financeiro.forEach(impacto => {
                    const checkbox = document.querySelector(`input[name="impacto_financeiro"][value="${impacto}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Com√©rcio
            document.getElementById('num_skus').value = record.data.num_skus ? record.data.num_skus[0] : '';
            if (record.data.comercio_dores) {
                record.data.comercio_dores.forEach(dor => {
                    const checkbox = document.querySelector(`input[name="comercio_dores"][value="${dor}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Sa√∫de
            document.getElementById('num_pacientes').value = record.data.num_pacientes ? record.data.num_pacientes[0] : '';
            if (record.data.saude_dores) {
                record.data.saude_dores.forEach(dor => {
                    const checkbox = document.querySelector(`input[name="saude_dores"][value="${dor}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Educa√ß√£o
            document.getElementById('num_alunos').value = record.data.num_alunos ? record.data.num_alunos[0] : '';
            if (record.data.educacao_dores) {
                record.data.educacao_dores.forEach(dor => {
                    const checkbox = document.querySelector(`input[name="educacao_dores"][value="${dor}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Crit√©rios escolha
            if (record.data.criterios_escolha) {
                record.data.criterios_escolha.forEach(criterio => {
                    const checkbox = document.querySelector(`input[name="criterios_escolha"][value="${criterio}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Tempo implementa√ß√£o
            if (record.data.tempo_implementacao) {
                document.querySelector(`input[name="tempo_implementacao"][value="${record.data.tempo_implementacao[0]}"]`).checked = true;
            }
            
            // Envolvidos
            if (record.data.envolvidos) {
                record.data.envolvidos.forEach(envolvido => {
                    if (envolvido === 'Outro' && record.data.envolvidos_outro) {
                        document.querySelector('input[name="envolvidos"][value="Outro"]').checked = true;
                        document.getElementById('envolvidos_outro').value = record.data.envolvidos_outro[0];
                    } else {
                        const checkbox = document.querySelector(`input[name="envolvidos"][value="${envolvido}"]`);
                        if (checkbox) checkbox.checked = true;
                    }
                });
            }
            
            // Urg√™ncia
            if (record.data.urgencia) {
                document.querySelector(`input[name="urgencia"][value="${record.data.urgencia[0]}"]`).checked = true;
            }
            
            // Campos texto
            document.getElementById('modulos_prioritarios').value = record.data.modulos_prioritarios ? record.data.modulos_prioritarios[0] : '';
            document.getElementById('observacoes').value = record.data.observacoes ? record.data.observacoes[0] : '';
            
            formModal.style.display = 'block';
        }

        function deleteRecord(id) {
            if (confirm('Tem certeza que deseja excluir este question√°rio?')) {
                const record = records.find(r => r.id === id);
                records = records.filter(r => r.id !== id);
                localStorage.setItem('diagnosisRecords', JSON.stringify(records));
                
                addNotification(
                    'Question√°rio Exclu√≠do',
                    `O question√°rio da empresa "${record.data.nome_empresa[0]}" foi exclu√≠do`,
                    'warning'
                );
                
                updateDashboard();
                applyFilters();
                showNotification('Question√°rio exclu√≠do com sucesso!', 'success');
            }
        }

        function exportData() {
            if (records.length === 0) {
                showNotification('Nenhum dado para exportar!', 'error');
                return;
            }
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + "ID,Empresa,Setor,Funcion√°rios,Faturamento,Filiais,Sistema,Tempo Sistema,Dores,Impacto Financeiro,SKUs,Dores Com√©rcio,Pacientes,Dores Sa√∫de,Alunos,Dores Educa√ß√£o,Crit√©rios Escolha,Tempo Implementa√ß√£o,Envolvidos,Urg√™ncia,M√≥dulos Priorit√°rios,Observa√ß√µes,Data,Criado Por\n"
                + records.map(record => {
                    const setor = record.data.setor ? record.data.setor[0] : '';
                    const funcionarios = record.data.num_funcionarios ? record.data.num_funcionarios[0] : '';
                    const faturamento = record.data.faturamento_mensal ? record.data.faturamento_mensal[0] : '';
                    const filiais = record.data.possui_filiais ? record.data.possui_filiais[0] : '';
                    const sistema = record.data.sistema_utilizado ? record.data.sistema_utilizado[0] : '';
                    const tempoSistema = record.data.tempo_sistema ? record.data.tempo_sistema[0] : '';
                    const dores = record.data.dores ? record.data.dores.join('; ') : '';
                    const impacto = record.data.impacto_financeiro ? record.data.impacto_financeiro.join('; ') : '';
                    const skus = record.data.num_skus ? record.data.num_skus[0] : '';
                    const doresComercio = record.data.comercio_dores ? record.data.comercio_dores.join('; ') : '';
                    const pacientes = record.data.num_pacientes ? record.data.num_pacientes[0] : '';
                    const doresSaude = record.data.saude_dores ? record.data.saude_dores.join('; ') : '';
                    const alunos = record.data.num_alunos ? record.data.num_alunos[0] : '';
                    const doresEducacao = record.data.educacao_dores ? record.data.educacao_dores.join('; ') : '';
                    const criterios = record.data.criterios_escolha ? record.data.criterios_escolha.join('; ') : '';
                    const tempoImplementacao = record.data.tempo_implementacao ? record.data.tempo_implementacao[0] : '';
                    const envolvidos = record.data.envolvidos ? record.data.envolvidos.join('; ') : '';
                    const urgencia = record.data.urgencia ? record.data.urgencia[0] : '';
                    const modulos = record.data.modulos_prioritarios ? record.data.modulos_prioritarios[0] : '';
                    const observacoes = record.data.observacoes ? record.data.observacoes[0] : '';
                    const data = new Date(record.createdAt).toLocaleDateString('pt-BR');
                    const criadoPor = record.createdBy || '';
                    
                    return `${record.id},"${record.data.nome_empresa ? record.data.nome_empresa[0] : ''}","${setor}","${funcionarios}","${faturamento}","${filiais}","${sistema}","${tempoSistema}","${dores}","${impacto}","${skus}","${doresComercio}","${pacientes}","${doresSaude}","${alunos}","${doresEducacao}","${criterios}","${tempoImplementacao}","${envolvidos}","${urgencia}","${modulos}","${observacoes}","${data}","${criadoPor}"`;
                }).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "diagnostico_erp.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            addNotification(
                'Exporta√ß√£o Conclu√≠da',
                'Os dados foram exportados com sucesso em formato CSV',
                'success'
            );
            
            showNotification('Dados exportados com sucesso!', 'success');
        }

        function exportPDF(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configura√ß√µes de fonte
            doc.setFont("helvetica");
            
            // Cabe√ßalho
            doc.setFontSize(18);
            doc.text('Question√°rio de Diagn√≥stico Avan√ßado ‚Äì Manda ERP', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`ID: ${record.id}`, 20, 25);
            doc.text(`Data: ${new Date(record.createdAt).toLocaleDateString('pt-BR')}`, 20, 30);
            doc.text(`Criado por: ${record.createdBy || 'N√£o informado'}`, 20, 35);
            
            // Se√ß√£o 1 - Perfil da Empresa
            doc.setFontSize(14);
            doc.text('Se√ß√£o 1 ‚Äì Perfil da Empresa', 20, 45);
            doc.setFontSize(12);
            
            let yPos = 55;
            doc.text(`Nome da empresa: ${record.data.nome_empresa ? record.data.nome_empresa[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            doc.text(`Setor: ${record.data.setor ? record.data.setor[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            doc.text(`N¬∫ de funcion√°rios: ${record.data.num_funcionarios ? record.data.num_funcionarios[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            doc.text(`Faturamento mensal: ${record.data.faturamento_mensal ? record.data.faturamento_mensal[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            
            let filiaisText = `Possui filiais: ${record.data.possui_filiais ? record.data.possui_filiais[0] : 'N√£o'}`;
            if (record.data.possui_filiais && record.data.possui_filiais[0] === 'Sim' && record.data.num_filiais) {
                filiaisText += ` (${record.data.num_filiais[0]})`;
            }
            doc.text(filiaisText, 20, yPos);
            yPos += 15;
            
            // Se√ß√£o 2 - Diagn√≥stico de Processos
            doc.setFontSize(14);
            doc.text('Se√ß√£o 2 ‚Äì Diagn√≥stico de Processos', 20, yPos);
            doc.setFontSize(12);
            yPos += 10;
            
            doc.text(`Sistema utilizado: ${record.data.sistema_utilizado ? record.data.sistema_utilizado[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            doc.text(`Tempo de uso: ${record.data.tempo_sistema ? record.data.tempo_sistema[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            
            let doresText = `Principais dores: ${record.data.dores ? record.data.dores.join(', ') : 'N√£o informado'}`;
            if (record.data.dores && record.data.dores.includes('Outro') && record.data.dores_outro) {
                doresText += ` (${record.data.dores_outro[0]})`;
            }
            doc.text(doresText, 20, yPos);
            yPos += 7;
            doc.text(`Impacto financeiro: ${record.data.impacto_financeiro ? record.data.impacto_financeiro.join(', ') : 'N√£o informado'}`, 20, yPos);
            yPos += 15;
            
            // Se√ß√£o 3 - Necessidades Espec√≠ficas
            doc.setFontSize(14);
            doc.text('Se√ß√£o 3 ‚Äì Necessidades Espec√≠ficas', 20, yPos);
            doc.setFontSize(12);
            yPos += 10;
            
            doc.text(`N¬∫ m√©dio de SKUs: ${record.data.num_skus ? record.data.num_skus[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            doc.text(`Dores Com√©rcio: ${record.data.comercio_dores ? record.data.comercio_dores.join(', ') : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            doc.text(`N¬∫ pacientes/m√™s: ${record.data.num_pacientes ? record.data.num_pacientes[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            doc.text(`Dores Sa√∫de: ${record.data.saude_dores ? record.data.saude_dores.join(', ') : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            doc.text(`N¬∫ alunos: ${record.data.num_alunos ? record.data.num_alunos[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            doc.text(`Dores Educa√ß√£o: ${record.data.educacao_dores ? record.data.educacao_dores.join(', ') : 'N√£o informado'}`, 20, yPos);
            yPos += 15;
            
            // Se√ß√£o 4 - Expectativas e Decis√£o
            doc.setFontSize(14);
            doc.text('Se√ß√£o 4 ‚Äì Expectativas e Decis√£o', 20, yPos);
            doc.setFontSize(12);
            yPos += 10;
            
            doc.text(`Crit√©rios de escolha: ${record.data.criterios_escolha ? record.data.criterios_escolha.join(', ') : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            doc.text(`Tempo de implementa√ß√£o: ${record.data.tempo_implementacao ? record.data.tempo_implementacao[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            
            let envolvidosText = `Envolvidos: ${record.data.envolvidos ? record.data.envolvidos.join(', ') : 'N√£o informado'}`;
            if (record.data.envolvidos && record.data.envolvidos.includes('Outro') && record.data.envolvidos_outro) {
                envolvidosText += ` (${record.data.envolvidos_outro[0]})`;
            }
            doc.text(envolvidosText, 20, yPos);
            yPos += 15;
            
            // Se√ß√£o 5 - An√°lise do Consultor
            doc.setFontSize(14);
            doc.text('Se√ß√£o 5 ‚Äì An√°lise do Consultor', 20, yPos);
            doc.setFontSize(12);
            yPos += 10;
            
            doc.text(`Urg√™ncia: ${record.data.urgencia ? record.data.urgencia[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            doc.text(`M√≥dulos Priorit√°rios: ${record.data.modulos_prioritarios ? record.data.modulos_prioritarios[0] : 'N√£o informado'}`, 20, yPos);
            yPos += 7;
            
            // Tratar observa√ß√µes longas
            const observacoes = record.data.observacoes ? record.data.observacoes[0] : 'N√£o informado';
            const splitObservacoes = doc.splitTextToSize(observacoes, 170);
            doc.text(splitObservacoes, 20, yPos);
            
            // Salvar PDF
            doc.save(`Diagnostico_ERP_${record.data.nome_empresa ? record.data.nome_empresa[0] : 'Sem Nome'}_${record.id}.pdf`);
            
            showNotification('PDF exportado com sucesso!', 'success');
        }

        function exportGlobalPDF() {
            if (records.length === 0) {
                showNotification('Nenhum dado para exportar!', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabe√ßalho
            doc.setFontSize(18);
            doc.text('Relat√≥rio Global - Question√°rios de Diagn√≥stico ERP', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Data de gera√ß√£o: ${new Date().toLocaleDateString('pt-BR')}`, 105, 25, { align: 'center' });
            doc.text(`Total de registros: ${records.length}`, 105, 30, { align: 'center' });
            
            // Preparar dados para a tabela
            const tableData = records.map(record => [
                record.id,
                record.data.nome_empresa ? record.data.nome_empresa[0] : 'N√£o informado',
                record.data.setor ? record.data.setor[0] : 'N√£o informado',
                record.data.num_funcionarios ? record.data.num_funcionarios[0] : 'N√£o informado',
                record.data.faturamento_mensal ? record.data.faturamento_mensal[0] : 'N√£o informado',
                record.data.urgencia ? record.data.urgencia[0] : 'N√£o informado',
                new Date(record.createdAt).toLocaleDateString('pt-BR'),
                record.createdBy || 'N√£o informado'
            ]);
            
            // Cabe√ßalhos da tabela
            const headers = [
                'ID',
                'Empresa',
                'Setor',
                'Funcion√°rios',
                'Faturamento',
                'Urg√™ncia',
                'Data',
                'Criado Por'
            ];
            
            // Adicionar tabela usando autoTable
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 40,
                theme: 'grid',
                headStyles: {
                    fillColor: [67, 97, 238],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 247, 250]
                },
                margin: { top: 40 }
            });
            
            // Adicionar estat√≠sticas
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(14);
            doc.text('Estat√≠sticas', 20, finalY);
            doc.setFontSize(12);
            
            // Calcular estat√≠sticas
            const uniqueCompanies = new Set();
            const sectorCount = {};
            const urgencyCount = {};
            
            records.forEach(record => {
                if (record.data.nome_empresa && record.data.nome_empresa[0]) {
                    uniqueCompanies.add(record.data.nome_empresa[0]);
                }
                
                const setor = record.data.setor ? record.data.setor[0] : 'N√£o informado';
                sectorCount[setor] = (sectorCount[setor] || 0) + 1;
                
                const urgencia = record.data.urgencia ? record.data.urgencia[0] : 'N√£o informado';
                urgencyCount[urgencia] = (urgencyCount[urgencia] || 0) + 1;
            });
            
            // Adicionar estat√≠sticas ao PDF
            let statsY = finalY + 10;
            doc.text(`Total de empresas √∫nicas: ${uniqueCompanies.size}`, 20, statsY);
            statsY += 7;
            
            doc.text('Distribui√ß√£o por setor:', 20, statsY);
            statsY += 7;
            Object.entries(sectorCount).forEach(([setor, count]) => {
                doc.text(`  ${setor}: ${count} (${((count / records.length) * 100).toFixed(1)}%)`, 25, statsY);
                statsY += 7;
            });
            
            statsY += 5;
            doc.text('Distribui√ß√£o por urg√™ncia:', 20, statsY);
            statsY += 7;
            Object.entries(urgencyCount).forEach(([urgencia, count]) => {
                doc.text(`  ${urgencia}: ${count} (${((count / records.length) * 100).toFixed(1)}%)`, 25, statsY);
                statsY += 7;
            });
            
            // Salvar PDF
            doc.save('Relatorio_Global_Diagnostico_ERP.pdf');
            
            addNotification(
                'Relat√≥rio Gerado',
                'O relat√≥rio global foi exportado com sucesso em PDF',
                'success'
            );
            
            showNotification('Relat√≥rio PDF global exportado com sucesso!', 'success');
        }

        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                    installBanner.style.display = 'none';
                });
            }
        }

        // Adicionar estilos para badges
        const style = document.createElement('style');
        style.textContent = `
            .badge {
                display: inline-block;
                padding: 3px 6px;
                font-size: 0.8rem;
                font-weight: bold;
                border-radius: 4px;
                color: white;
            }
            .badge-danger {
                background-color: var(--danger);
            }
            .badge-warning {
                background-color: var(--warning);
            }
            .badge-info {
                background-color: var(--primary);
            }
        `;
        document.head.appendChild(style);

        // Inicializa√ß√£o
        // Verificar se j√° existe um usu√°rio logado
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                currentUserSpan.textContent = currentUser.username;
                userRoleSpan.textContent = currentUser.role === 'admin' ? 'Administrador' : 'Funcion√°rio';
                loginContainer.style.display = 'none';
                dashboard.style.display = 'block';
                setupPermissions();
                updateDashboard();
                updateNotificationBadge();
                applyFilters();
            } catch (e) {
                localStorage.removeItem('currentUser');
            }
        }

        // Simular notifica√ß√µes peri√≥dicas para admin
        if (currentUser && currentUser.role === 'admin') {
            setInterval(() => {
                // Notifica√ß√£o sobre novos registros de alta prioridade
                const highPriorityRecords = records.filter(r => 
                    r.data.urgencia && 
                    r.data.urgencia[0] === 'Alta' && 
                    new Date(r.createdAt) > new Date(Date.now() - 24 * 60 * 60 * 1000)
                );
                
                if (highPriorityRecords.length > 0) {
                    addNotification(
                        'Aten√ß√£o: Registros de Alta Prioridade',
                        `Existem ${highPriorityRecords.length} question√°rios com urg√™ncia alta criados nas √∫ltimas 24 horas`,
                        'warning'
                    );
                }
                
                // Notifica√ß√£o sobre inatividade
                const recentRecords = records.filter(r => 
                    new Date(r.createdAt) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
                );
                
                if (recentRecords.length === 0 && records.length > 0) {
                    addNotification(
                        'Inatividade Detectada',
                        'Nenhum novo question√°rio foi adicionado na √∫ltima semana',
                        'info'
                    );
                }
            }, 60000); // Verificar a cada minuto
        }
    </script>
</body>
</html>
